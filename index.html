<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Force-Directed Graph</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
</head>

<body>
    <p id="bookmarklet">
        <a
            href="javascript:%20(async%20()%20=>%20{%20function%20sleep(ms)%20{%20return%20new%20Promise((resolve)%20=>%20setTimeout(resolve,%20ms));%20}%20async%20function%20getMutualFriendsFetch(user)%20{%20const%20mutualFriendsRes%20=%20await%20fetch(%20`https://www.instagram.com/api/v1/friendships/${user.pk}/mutual_followers/`,%20{%20headers:%20{%20'x-ig-app-id':%20'936619743392459',%20},%20}%20);%20await%20sleep(500);%20let%20mutualFriends%20=%20await%20mutualFriendsRes.json();%20return%20mutualFriends.users.map((mutualFriend)%20=>%20mutualFriend.username);%20}%20async%20function%20getMutualFriends(user,%20graph)%20{%20const%20mutualFriends%20=%20await%20getMutualFriendsFetch(user);%20graph.nodes%20=%20graph.nodes.concat(%20mutualFriends.map((mutualFriend)%20=>%20{%20return%20{%20id:%20mutualFriend,%20group:%201%20};%20})%20);%20graph.links%20=%20graph.links.concat(%20mutualFriends.map((mutualFriendUsername)%20=>%20({%20source:%20mutualFriendUsername,%20target:%20user.username,%20value:%201,%20}))%20);%20}%20async%20function%20getLoggedFollowersFetch(pk,%20step,%20after)%20{%20const%20res%20=%20await%20fetch(%20`https://www.instagram.com/graphql/query/?query_hash=c76146de99bb02f6415203be841dd25a&variables=`%20+%20encodeURIComponent(%20JSON.stringify({%20id:%20pk,%20include_reel:%20true,%20fetch_mutual:%20true,%20first:%20step,%20after:%20after,%20})%20),%20{%20headers:%20{%20'x-ig-app-id':%20'936619743392459',%20},%20}%20);%20const%20jsonRes%20=%20await%20res.json();%20return%20jsonRes.data.user.edge_followed_by;%20}%20async%20function%20getLoggedFollowers(user,%20graph)%20{%20let%20after%20=%20null,%20has_next%20=%20true,%20count%20=%200,%20step%20=%20500,%20limit%20=%20500,%20username%20=%20user.username;%20while%20(has_next%20&&%20count%20<%20limit)%20{%20let%20results%20=%20await%20getLoggedFollowersFetch(user.pk,%20step,%20after);%20has_next%20=%20results.page_info.has_next_page;%20after%20=%20results.page_info.end_cursor;%20count%20+=%20results.edges.length;%20graph.nodes%20=%20graph.nodes.concat(%20results.edges.map(({%20node%20})%20=>%20{%20return%20{%20id:%20node.username,%20group:%201%20};%20})%20);%20graph.links%20=%20graph.links.concat(%20results.edges.map(({%20node%20})%20=>%20{%20return%20{%20source:%20node.username,%20target:%20username,%20value:%201,%20};%20})%20);%20}%20}%20async%20function%20getUserInfo(username)%20{%20const%20userQueryRes%20=%20await%20fetch(%20`https://www.instagram.com/web/search/topsearch/?query=${username}/`%20);%20const%20userQueryJson%20=%20await%20userQueryRes.json();%20if%20(%20!userQueryJson.users%20||%20userQueryJson.users.length%20===%200%20||%20!userQueryJson.users[0].user%20)%20{%20throw%20new%20Error('User%20not%20found');%20}%20return%20userQueryJson.users[0].user;%20}%20async%20function%20addUserInfoToGraph(%20username%20=%20'',%20graph,%20infoFetchFn%20=%20async%20()%20=>%20{}%20)%20{%20if%20(!username)%20throw%20new%20Error('Username%20is%20required');%20console.log(`Getting%20user%20info%20for%20${username}...`);%20if%20(!graph.nodes.find((n)%20=>%20n%20&&%20n.id%20&&%20n.id%20===%20username))%20{%20graph.nodes.push({%20id:%20username,%20group:%201%20});%20}%20let%20user%20=%20await%20getUserInfo(username);%20await%20infoFetchFn(user,%20graph);%20}%20function%20deduped(array,%20key)%20{%20return%20array.reduce((acc,%20current)%20=>%20{%20const%20x%20=%20acc.find((item)%20=>%20item[key]%20===%20current[key]);%20if%20(!x)%20{%20acc.push(current);%20}%20return%20acc;%20},%20[]);%20}%20async%20function%20makeGraph(loggedUsername)%20{%20const%20graph%20=%20{%20nodes:%20[],%20links:%20[],%20};%20try%20{%20await%20addUserInfoToGraph(loggedUsername,%20graph,%20getLoggedFollowers);%20const%20followers%20=%20graph.nodes%20.map((n)%20=>%20n.id)%20.filter((n)%20=>%20n%20!==%20undefined%20&&%20n%20!==%20loggedUsername);%20for%20(const%20follow%20of%20followers)%20{%20await%20addUserInfoToGraph(follow,%20graph,%20getMutualFriends);%20}%20}%20catch%20(err)%20{%20console.log({%20err%20});%20}%20graph.nodes%20=%20deduped(graph.nodes,%20'id');%20return%20graph;%20}%20function%20downloadData(data,%20format%20=%20'json')%20{%20const%20a%20=%20document.createElement('a');%20a.href%20=%20URL.createObjectURL(%20new%20Blob([JSON.stringify(data,%20null,%202)],%20{%20type:%20'text/plain',%20})%20);%20a.setAttribute('download',%20`ig-social-data.${format}`);%20document.body.appendChild(a);%20a.click();%20document.body.removeChild(a);%20}%20let%20loggedUsername;%20try%20{%20loggedUsername%20=%20window._sharedData.config.viewer.username;%20}%20catch%20(_)%20{%20loggedUsername%20=%20undefined;%20}%20if%20(loggedUsername%20===%20''%20||%20loggedUsername%20===%20undefined)%20{%20alert(%20'Could not%20find%20logged%20username.%20Please%20make%20sure%20you%20are%20in%20instagram%20and%20are%20logged%20in.'%20);%20return;%20}%20console.log(%20`Getting%20user%20info%20for%20${loggedUsername}.%20This%20may%20take%20a%2015-20%20seconds...`%20);%20const%20graph%20=%20await%20makeGraph(loggedUsername);%20graph.username%20=%20loggedUsername;%20downloadData(graph);%20console.log('Done%20getting%20user%20info.');%20})();">
            Drag this to your bookmark folder</a>
    </p>
    <div id="file-input-container" class="file-input-container">
        <input id="file" type="file" accept=".json" class="big-input">
        <label class="file-input-label">Drag file here</label>
    </div>
    <svg></svg>
</body>
<script type="module" src="index.js"></script>
<script type="module" src="uploadHandler.js"></script>
<style>
    html,
    body {
        width: 100%;
        height: 100%;
        overflow: hidden;
    }

    svg {
        width: 0;
        height: 0;
    }

    .link {
        stroke: #999;
        stroke-opacity: 0.2;
        stroke-width: 1px;
    }

    .nodes circle {
        stroke: #fff;
        stroke-width: 0.5px;
    }

    .file-input-container {
        position: relative;
    }

    .big-input {
        width: 95%;
        height: 90vh;
        padding: 12px 20px;
        margin: 8px 0;
        box-sizing: border-box;
        border: 2px solid #ccc;
        border-radius: 4px;
    }

    .file-input-label {
        position: absolute;
        font-size: 50px;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        pointer-events: none;
    }
</style>

</html>